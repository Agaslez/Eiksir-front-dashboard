name: Smoke Tests - Pre-Deployment

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # RÄ™czne uruchomienie

jobs:
  smoke-tests:
    name: ğŸ”¥ Critical System Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ­ Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: ğŸš€ Start Frontend (dev server)
        run: |
          npm run dev &
          sleep 10
          echo "Frontend started on http://localhost:5174"

      - name: â³ Wait for services to be ready
        run: |
          echo "Waiting for frontend..."
          npx wait-on http://localhost:5174 --timeout 30000
          echo "Checking backend (Render)..."
          npx wait-on https://stefano-eliksir-backend.onrender.com/health --timeout 60000 || npx wait-on https://stefano-eliksir-backend.onrender.com/api/config --timeout 60000
          echo "âœ… All services ready"

      - name: ğŸ”¥ Run Smoke Tests
        run: npx playwright test smoke.spec.ts --project=chromium
        env:
          FRONTEND_URL: http://localhost:5174
          BACKEND_URL: https://stefano-eliksir-backend.onrender.com

      - name: ğŸ“Š Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-results
          path: |
            playwright-report/
            test-results/
          retention-days: 7

      - name: âŒ Fail deployment on smoke test failure
        if: failure()
        run: |
          echo "::error::ğŸš¨ SMOKE TESTS FAILED - DEPLOYMENT BLOCKED"
          echo "::error::Critical system components are not healthy"
          echo "::error::Fix the issues before deploying to production"
          exit 1

      - name: âœ… Success - Ready to deploy
        if: success()
        run: |
          echo "::notice::âœ… All smoke tests passed"
          echo "::notice::System is healthy - deployment can proceed"
