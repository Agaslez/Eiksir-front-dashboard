name: ğŸ›¡ï¸ GIT-Cerber - Schema Guardian

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: 20

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # GUARDIAN - Frontend Schema Validation (FIRST STEP - Fast Fail)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  guardian-schema-validation:
    name: ğŸ›¡ï¸ Guardian Schema Check
    runs-on: ubuntu-latest
    timeout-minutes: 3
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit
      
      - name: ğŸ›¡ï¸ Run Guardian Schema Validator
        id: guardian
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ›¡ï¸  GUARDIAN SCHEMA VALIDATION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # Run validator and capture output
          if node scripts/validate-schema.mjs; then
            echo ""
            echo "âœ… Guardian validation PASSED"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo ""
            echo "âŒ Guardian validation FAILED"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi
        continue-on-error: true
        # âš ï¸ TEMPORARY: Set to 'true' for soft launch (warns but doesn't block)
        # ğŸ”’ PRODUCTION: Change to 'false' when ready to enforce (blocks merge)
      
      - name: ğŸ“Š Guardian Result Summary
        if: always()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š GUARDIAN VALIDATION RESULT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          if [ "${{ steps.guardian.outputs.status }}" = "success" ]; then
            echo "âœ… Status: PASSED"
            echo "âœ… All schema checks successful"
            echo "âœ… Single Source of Truth validated"
          else
            echo "âš ï¸  Status: FAILED (non-blocking)"
            echo "âš ï¸  Schema violations detected"
            echo ""
            echo "ğŸ’¡ IMPORTANT:"
            echo "   This is currently in SOFT MODE (continue-on-error: true)"
            echo "   Violations are logged but don't block the workflow"
            echo ""
            echo "ğŸ”’ To enable strict enforcement:"
            echo "   Edit .github/workflows/git-cerber.yml"
            echo "   Change 'continue-on-error: true' to 'false'"
          fi
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: ğŸ’¬ Comment on PR (if violations found)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âš ï¸ Guardian Schema Violations Detected
              
              **Status:** Failed (non-blocking in soft mode)
              
              The Guardian schema validator detected violations of the Single Source of Truth (FRONTEND_SCHEMA.ts).
              
              ### ğŸ“‹ What to do:
              1. Check the workflow logs for detailed violation messages
              2. Fix violations according to FRONTEND_SCHEMA.ts rules
              3. If legitimate exception: Add architect approval comment
              4. Re-push to re-run validation
              
              ### ğŸ” Common violations:
              - Hardcoded URLs (use \`import { API } from '@/lib/config'\`)
              - Missing retry logic (use \`fetchWithRetry\`)
              - Console.log without approval
              - Missing required imports
              
              ### ğŸ“š Documentation:
              - [FRONTEND_SCHEMA.ts](../FRONTEND_SCHEMA.ts)
              - [ARCHITECT_APPROVAL_GUIDE.md](../ARCHITECT_APPROVAL_GUIDE.md)
              
              **Note:** This check is currently in **soft mode** and won't block merge. Review and fix violations before next sprint when strict mode activates.`
            })

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # PERFORMANCE BUDGET - Bundle Size Check (Optional)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  performance-budget:
    name: ğŸ“¦ Performance Budget Check
    runs-on: ubuntu-latest
    needs: guardian-schema-validation
    timeout-minutes: 5
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: npm ci --prefer-offline --no-audit
      
      - name: ğŸ—ï¸ Build production bundle
        run: npm run build
        env:
          VITE_API_URL: https://api.eliksir-bar.pl
          VITE_APP_NAME: Eliksir Bar
          VITE_APP_ENV: production
      
      - name: ğŸ“Š Check bundle size
        id: bundle
        run: |
          echo "Checking bundle size against performance budget..."
          
          # Get total dist size (in KB)
          TOTAL_SIZE=$(du -sk dist | cut -f1)
          echo "Total bundle size: ${TOTAL_SIZE} KB"
          
          # Performance budget limits (from contract.json concept)
          MAX_SIZE=500  # 500 KB
          WARN_SIZE=400 # 400 KB
          
          echo "total_size=$TOTAL_SIZE" >> $GITHUB_OUTPUT
          echo "max_size=$MAX_SIZE" >> $GITHUB_OUTPUT
          echo "warn_size=$WARN_SIZE" >> $GITHUB_OUTPUT
          
          if [ $TOTAL_SIZE -gt $MAX_SIZE ]; then
            echo "âŒ Bundle size EXCEEDS limit: ${TOTAL_SIZE} KB > ${MAX_SIZE} KB"
            echo "status=exceeded" >> $GITHUB_OUTPUT
            exit 1
          elif [ $TOTAL_SIZE -gt $WARN_SIZE ]; then
            echo "âš ï¸  Bundle size WARNING: ${TOTAL_SIZE} KB > ${WARN_SIZE} KB (limit: ${MAX_SIZE} KB)"
            echo "status=warning" >> $GITHUB_OUTPUT
          else
            echo "âœ… Bundle size OK: ${TOTAL_SIZE} KB < ${WARN_SIZE} KB"
            echo "status=ok" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true
        # âš ï¸ TEMPORARY: Non-blocking, just informational
      
      - name: ğŸ“Š Bundle Size Report
        if: always()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¦ PERFORMANCE BUDGET REPORT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Total size:    ${{ steps.bundle.outputs.total_size }} KB"
          echo "Warning at:    ${{ steps.bundle.outputs.warn_size }} KB"
          echo "Max allowed:   ${{ steps.bundle.outputs.max_size }} KB"
          echo ""
          
          case "${{ steps.bundle.outputs.status }}" in
            "ok")
              echo "âœ… Status: OPTIMAL"
              echo "âœ… Bundle is within performance budget"
              ;;
            "warning")
              echo "âš ï¸  Status: WARNING"
              echo "âš ï¸  Bundle approaching limit - consider:"
              echo "   - Code splitting"
              echo "   - Lazy loading"
              echo "   - Image optimization"
              ;;
            "exceeded")
              echo "âŒ Status: EXCEEDED (non-blocking)"
              echo "âŒ Bundle too large - action required:"
              echo "   - Analyze with: npm run build -- --mode production"
              echo "   - Check largest chunks"
              echo "   - Remove unused dependencies"
              ;;
          esac
          
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STATUS SUMMARY - Aggregate Results
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  cerber-summary:
    name: ğŸ“‹ GIT-Cerber Summary
    runs-on: ubuntu-latest
    needs: [guardian-schema-validation, performance-budget]
    if: always()
    
    steps:
      - name: ğŸ“Š Generate Summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ›¡ï¸  GIT-CERBER VALIDATION SUMMARY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Guardian Schema:      ${{ needs.guardian-schema-validation.result }}"
          echo "Performance Budget:   ${{ needs.performance-budget.result }}"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "â„¹ï¸  GIT-Cerber Status: SOFT MODE"
          echo "   All checks are informational (continue-on-error: true)"
          echo "   Violations are logged but don't block workflow"
          echo ""
          echo "ğŸ”’ To enable strict enforcement:"
          echo "   1. Review violations in past runs"
          echo "   2. Fix all existing issues"
          echo "   3. Change 'continue-on-error: true' â†’ 'false'"
          echo "   4. GIT-Cerber will then block merges on violations"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
